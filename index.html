<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta property="og:title" content="My Universe">
    <meta property="og:description" content="A space dedicated to us. â™¾ï¸">
    <meta property="og:image" content="preview.png">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Lora:ital,wght@1,400;1,500&display=swap" rel="stylesheet">

    <style>
        /* 
         * BROWSER COMPATIBILITY NOTES:
         * - Tested on Chrome, Firefox, Safari (iOS/macOS), Edge
         * - Webkit prefixes for iOS Safari and older Chrome
         * - Touch events + mouse events for desktop/mobile
         * - visualViewport API with fallback for older browsers
         * - WebAudio API with webkit prefix for Safari
         * - Safe area insets for notched devices
         * - Hardware acceleration via will-change and transform
         */
        
        /* --- 1. DESIGN SYSTEM --- */
        :root { 
            --gold: #ffd700; 
            --rose-gold: #ffc4d6;
            --love-pink: #ff66b2;
            --neon-pink: #ff00cc;
            --neon-green: #39ff14;
            --space-center: #1a0b2e; 
            --space-edge: #050014;   
            --white: #fff0f5; 
            --glass-bg: rgba(30, 15, 40, 0.95);
            --glass-border: rgba(255, 182, 193, 0.4); 
            
            --font-display: 'Lora', serif;
            --font-body: 'Lato', sans-serif;
        }

        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background-color: var(--space-edge); 
            font-family: var(--font-body);
            color: var(--white); display: flex; justify-content: center; align-items: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -ms-touch-action: manipulation;
        }

        @supports (height: 100dvh) {
            html, body { height: 100dvh; }
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #warp-canvas { z-index: 2; mix-blend-mode: screen; transition: opacity 2.5s ease; }
        #universe-canvas { z-index: 0; opacity: 0; transition: opacity 3s ease-in; }

        .bg-gradient { 
            position: absolute; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, var(--space-center) 0%, var(--space-edge) 90%); 
            z-index: -10; 
        }

        /* --- TITLE WRAPPER (Clickable) --- */
        .title-wrapper {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; text-align: center; width: 90%; opacity: 1; 
            animation: fade-in 3s forwards 1s;
            -webkit-animation: fade-in 3s forwards 1s;
            cursor: pointer; /* Clickable */
        }

        /* --- TITLE STYLING --- */
        #dynamic-text { 
            font-family: var(--font-display); 
            font-weight: 500; 
            font-style: italic;
            font-size: clamp(2rem, 5.5vw, 4rem); 
            letter-spacing: 0.02em; margin: 0; line-height: 1.2;
            color: var(--white); 
            text-shadow: 0 0 15px rgba(255, 105, 180, 0.4), 0 0 30px rgba(255, 255, 255, 0.1);
            transition: opacity 1.5s, transform 0.1s ease;
            pointer-events: none;
            white-space: nowrap;
            display: inline-block;
            max-width: 90vw;
        }

        #dynamic-text:hover { transform: scale(1.02); color: var(--rose-gold); text-shadow: 0 0 25px var(--love-pink); }

        /* --- POINTER & HINT --- */
        .hint-wrapper {
            margin-top: 15px;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0.8; transition: opacity 1s;
        }

        .click-arrow {
            font-size: 1.5rem; color: var(--gold);
            animation: bounce 2s infinite;
            -webkit-animation: bounce 2s infinite;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .click-hint {
            display: block; font-family: var(--font-body);
            font-size: 0.75rem; font-weight: 300;
            letter-spacing: 2px; color: rgba(255, 192, 203, 0.7);
            text-transform: uppercase;
        }

        .start-btn {
            margin-top: 8px; padding: 6px 10px; border-radius: 0;
            border: none; cursor: pointer; font-family: var(--font-body);
            font-size: 1.6rem; font-weight: 600; line-height: 1;
            background: transparent; color: var(--rose-gold);
            box-shadow: none; transition: none; pointer-events: auto;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
        }
        .start-btn-positioned {
            position: absolute; top: 62%; left: 50%; transform: translate(-50%, 0);
            z-index: 150; display: inline-block;
        }

        /* --- UI CONTAINER --- */
        #ui-container {
            position: fixed; bottom: calc(14% + var(--safe-bottom)); width: 100%; text-align: center;
            z-index: 90; pointer-events: none; opacity: 0;
            transition: opacity 2s;
        }

        #star-counter {
            font-family: var(--font-display); 
            font-size: 1.4rem; color: var(--gold); font-style: italic;
            margin-bottom: 12px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            transition: opacity 1.2s ease, transform 0.4s ease;
        }

        #star-counter.complete {
            color: var(--love-pink); text-shadow: 0 0 20px var(--love-pink);
            font-size: 1.6rem; 
            animation: pulse-hint 1.6s infinite;
            -webkit-animation: pulse-hint 1.6s infinite;
        }

        #star-counter.hidden {
            opacity: 0; visibility: hidden;
        }

        #explore-hint {
            font-family: var(--font-body);
            font-size: 0.9rem; letter-spacing: 1px; font-weight: 300;
            color: var(--rose-gold); 
            text-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
            transition: opacity 0.5s ease, transform 0.3s ease;
            pointer-events: none;
        }

        #explore-hint.active-trigger {
            pointer-events: auto;
            cursor: default;
            text-shadow: 0 0 15px var(--love-pink);
        }

        .click-span {
            text-decoration: underline; text-underline-offset: 4px;
            font-weight: 400; margin-left: 6px; color: var(--gold);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            display: inline-block;
        }
        .click-span:hover {
            color: var(--white);
            transform: scale(1.05);
        }

        /* --- PROGRESS BAR --- */
        #progress-container {
            position: fixed; bottom: var(--safe-bottom); left: 0; width: 100%; height: 4px;
            background: rgba(255, 255, 255, 0.05); z-index: 100; opacity: 0; transition: opacity 1s;
        }
        #progress-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--love-pink), var(--gold));
            box-shadow: 0 0 15px var(--love-pink); transition: width 0.2s linear;
        }

        /* --- VISIBLE MEMORY STARS --- */
        .memory-btn {
            position: absolute; width: 48px; height: 48px; display: flex; 
            justify-content: center; align-items: center; z-index: 80;
            cursor: pointer; touch-action: manipulation;
            opacity: 0; transition: opacity 3s;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }

        body.active .memory-btn { opacity: 0.6; pointer-events: auto; }

        /* Highlight memory buttons when the explore hint is clicked */
        body.highlight-mem .memory-btn { 
            opacity: 1; 
            -webkit-transform: translate(-50%, -50%) scale(1.08);
            -ms-transform: translate(-50%, -50%) scale(1.08);
            transform: translate(-50%, -50%) scale(1.08); 
            -webkit-transition: transform 0.25s ease, opacity 0.25s ease;
            transition: transform 0.25s ease, opacity 0.25s ease;
            will-change: transform, opacity;
        }
        body.highlight-mem .hint-dot { 
            width: 10px; 
            height: 10px; 
            box-shadow: 0 0 22px var(--love-pink), 0 0 40px var(--gold);
            will-change: width, height, box-shadow;
        }

        .hint-dot { 
            position: absolute; 
            width: 4px; height: 4px; 
            background: #fff; border-radius: 50%; 
            box-shadow: 0 0 6px #fff, 0 0 12px var(--rose-gold); 
            opacity: 0.85; 
            transition: 0.4s ease-in-out; 
        }

        @keyframes star-pulse {
            0% { transform: scale(1); opacity: 0.7; box-shadow: 0 0 5px #fff; }
            50% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 20px var(--gold), 0 0 30px var(--love-pink); }
            100% { transform: scale(1); opacity: 0.7; box-shadow: 0 0 5px #fff; }
        }

        @-webkit-keyframes star-pulse {
            0% { -webkit-transform: scale(1); opacity: 0.7; box-shadow: 0 0 5px #fff; }
            50% { -webkit-transform: scale(1.6); opacity: 1; box-shadow: 0 0 20px var(--gold), 0 0 30px var(--love-pink); }
            100% { -webkit-transform: scale(1); opacity: 0.7; box-shadow: 0 0 5px #fff; }
        }

        .memory-btn:nth-child(1) .hint-dot { animation: star-pulse 4s infinite ease-in-out 0s; -webkit-animation: star-pulse 4s infinite ease-in-out 0s; }
        .memory-btn:nth-child(2) .hint-dot { animation: star-pulse 5s infinite ease-in-out 1.5s; -webkit-animation: star-pulse 5s infinite ease-in-out 1.5s; }
        .memory-btn:nth-child(3) .hint-dot { animation: star-pulse 4.5s infinite ease-in-out 3s; -webkit-animation: star-pulse 4.5s infinite ease-in-out 3s; }
        .memory-btn:nth-child(4) .hint-dot { animation: star-pulse 6s infinite ease-in-out 0.5s; -webkit-animation: star-pulse 6s infinite ease-in-out 0.5s; }
        .memory-btn:nth-child(5) .hint-dot { animation: star-pulse 5.5s infinite ease-in-out 2.5s; -webkit-animation: star-pulse 5.5s infinite ease-in-out 2.5s; }
        .memory-btn:nth-child(6) .hint-dot { animation: star-pulse 7s infinite ease-in-out 4s; -webkit-animation: star-pulse 7s infinite ease-in-out 4s; }

        .memory-btn:hover .hint-dot, .memory-btn.touch-active .hint-dot { 
            background: var(--rose-gold); width: 8px; height: 8px;
            box-shadow: 0 0 18px var(--love-pink), 0 0 30px var(--gold); 
            transform: scale(1.4); 
            -webkit-transform: scale(1.4);
            opacity: 1;
            animation: none; 
            -webkit-animation: none;
        }

        /* --- ZODIAC ZONES --- */
        .zodiac-zone {
            position: absolute; width: 140px; height: 140px;
            z-index: 150; cursor: pointer;
            transform: translate(-50%, -50%);
            opacity: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        
        .zodiac-zone .zodiac-symbol {
            font-size: 3.2rem; margin-bottom: 6px; text-shadow: 0 0 15px rgba(255, 192, 203, 0.6);
            display: block;
        }
        
        .zodiac-zone .zodiac-label {
            font-family: var(--font-body); font-size: 0.85rem; letter-spacing: 0.5px;
            color: rgba(255, 192, 203, 0.8); font-weight: 300; text-transform: uppercase;
            text-shadow: 0 0 8px rgba(255, 192, 203, 0.4);
            display: block;
        }
        
        body.active .zodiac-zone { pointer-events: auto; }

        /* --- MEMORY/ZODIAC POSITIONS (DESKTOP DEFAULT) --- */
        #memory-1 { top: 18%; left: 12%; }
        #memory-2 { top: 75%; left: 25%; }
        #memory-3 { top: 45%; left: 88%; }
        #memory-4 { top: 80%; left: 80%; }
        #memory-5 { top: 50%; left: 8%; }
        #memory-6 { top: 15%; left: 75%; }

        #zodiac-1 { top: 20%; left: 78%; }
        #zodiac-2 { top: 75%; left: 18%; }

        /* --- CARD STYLING --- */
        .message-box { 
            position: fixed; top: 50%; left: 50%; 
            -webkit-transform: translate(-50%, -50%) scale(0.95);
            -ms-transform: translate(-50%, -50%) scale(0.95);
            transform: translate(-50%, -50%) scale(0.95);
            width: 85%; max-width: 360px; padding: 40px 25px; 
            background: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px; text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 30px rgba(255, 105, 180, 0.15);
            z-index: 200; 
            opacity: 0; pointer-events: none; 
            transition: all 0.3s ease; 
            max-height: 82vh; overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin; 
            scrollbar-color: var(--rose-gold) transparent;
        }

        .message-box::-webkit-scrollbar {
            width: 6px;
        }

        .message-box::-webkit-scrollbar-track {
            background: transparent;
        }

        .message-box::-webkit-scrollbar-thumb {
            background: var(--rose-gold);
            border-radius: 3px;
        }

        .message-box.visible { 
            opacity: 1; 
            -webkit-transform: translate(-50%, -50%) scale(1);
            -ms-transform: translate(-50%, -50%) scale(1);
            transform: translate(-50%, -50%) scale(1); 
            pointer-events: auto; 
        }

        .msg-header { margin-bottom: 12px; }
        .msg-emoji { display: block; font-size: 2.5rem; margin-bottom: 8px; filter: drop-shadow(0 0 20px rgba(255,105,180,0.4)); }
        
        .msg-title { 
            font-family: var(--font-display); 
            font-style: italic; font-weight: 500;
            color: var(--rose-gold); 
            font-size: 1.4rem; letter-spacing: 0.5px; margin: 0;
            border-bottom: 1px solid rgba(255, 182, 193, 0.3); display: inline-block; padding-bottom: 8px;
        }
        
        .msg-body { 
            font-family: var(--font-body); 
            color: #fff0f5; 
            line-height: 1.6; 
            font-size: 1rem; 
            font-weight: 300;
            margin-top: 18px;
            text-wrap: balance; 
        }

        .modal-close-btn {
            margin-top: 25px; padding: 10px 30px;
            background: transparent; border: 1px solid var(--rose-gold);
            color: var(--white); border-radius: 20px;
            font-family: var(--font-body); 
            font-size: 0.9rem;
            cursor: pointer; transition: 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
        }
        .modal-close-btn:hover { background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 10px var(--rose-gold); }

        .story-block { margin-bottom: 35px; text-align: left; }
        .story-title { 
            color: var(--gold); 
            font-family: var(--font-display); 
            font-weight: 600; display: block; margin-bottom: 8px; letter-spacing: 0.5px; 
        }

        /* --- ANIMATIONS --- */
        body.active #warp-canvas { opacity: 0; }
        body.active #universe-canvas { opacity: 1; }
        body.active .hint-wrapper { opacity: 0 !important; visibility: hidden; }
        body.active #ui-container { opacity: 1; }
        body.active #progress-container { opacity: 1; }
        /* Keep title visible but non-interactive when experience starts so the looping text remains readable */
        body.active .title-wrapper { pointer-events: none; z-index: 50; transform: translate(-50%, -50%) scale(0.98); transition: transform 0.2s ease; }

        @keyframes fade-in { to { opacity: 1; } }
        @-webkit-keyframes fade-in { to { opacity: 1; } }
        
        @keyframes pulse-hint { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
        @-webkit-keyframes pulse-hint { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
        
        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 
            40% { transform: translateY(-6px); } 
            60% { transform: translateY(-3px); } 
        }
        @-webkit-keyframes bounce { 
            0%, 20%, 50%, 80%, 100% { -webkit-transform: translateY(0); } 
            40% { -webkit-transform: translateY(-6px); } 
            60% { -webkit-transform: translateY(-3px); } 
        }
        
        .text-fade-out { 
            opacity: 0 !important; 
            transform: scale(0.95);
            -webkit-transform: scale(0.95);
        }

        /* --- RESPONSIVE DESIGN FOR ALL SCREEN SIZES --- */
        
        /* Extra small devices (< 320px) */
        @media (max-width: 319px) {
            #dynamic-text { font-size: clamp(1rem, 8vw, 1.8rem); }
            .memory-btn { width: 44px; height: 44px; }
            .zodiac-zone { width: 75px; height: 75px; }
            .zodiac-label { font-size: 0.7rem; }
            .title-wrapper { width: 95%; top: 20%; }
            .start-btn { font-size: 0.9rem; }
            .start-btn-positioned { top: 92%; }
            #ui-container { bottom: calc(2% + var(--safe-bottom)); height: 8%; }
            #star-counter { font-size: 0.75rem; margin-bottom: 4px; }
            #explore-hint { font-size: 0.65rem; padding: 0 4px; }
            .message-box { width: 94%; padding: 20px 14px; font-size: 0.9rem; }
            
            #memory-1 { top: 8%; left: 8%; }
            #memory-2 { top: 72%; left: 18%; }
            #memory-3 { top: 30%; left: 92%; }
            #memory-4 { top: 75%; left: 88%; }
            #memory-5 { top: 40%; left: 4%; }
            #memory-6 { top: 6%; left: 80%; }
            #zodiac-1 { top: 18%; left: 80%; }
            #zodiac-2 { top: 68%; left: 18%; }
        }

        /* Small phones (320px - 479px) */
        @media (min-width: 320px) and (max-width: 479px) {
            #dynamic-text { font-size: clamp(1.2rem, 9vw, 2.2rem); line-height: 1.1; letter-spacing: 0.01em; }
            .memory-btn { width: 48px; height: 48px; }
            .title-wrapper { top: 25%; width: 93%; }
            .zodiac-zone { width: 80px; height: 80px; }
            .zodiac-label { font-size: 0.72rem; }
            .start-btn { font-size: 1rem; }
            .start-btn-positioned { top: 91%; }
            #ui-container { bottom: calc(2.5% + var(--safe-bottom)); height: 8%; }
            #star-counter { font-size: 0.85rem; margin-bottom: 3px; }
            #explore-hint { font-size: 0.68rem; letter-spacing: 0.2px; padding: 0 6px; }
            .message-box { width: 91%; padding: 24px 16px; font-size: 0.92rem; }

            #memory-1 { top: 10%; left: 8%; }
            #memory-2 { top: 74%; left: 18%; }
            #memory-3 { top: 32%; left: 92%; }
            #memory-4 { top: 76%; left: 88%; }
            #memory-5 { top: 42%; left: 5%; }
            #memory-6 { top: 8%; left: 80%; }
            #zodiac-1 { top: 20%; left: 80%; }
            #zodiac-2 { top: 70%; left: 18%; }
        }

        /* Medium phones (480px - 599px) */
        @media (min-width: 480px) and (max-width: 599px) {
            #dynamic-text { font-size: clamp(1.4rem, 8.5vw, 2.6rem); }
            .memory-btn { width: 52px; height: 52px; }
            .title-wrapper { top: 27%; width: 91%; }
            .zodiac-zone { width: 90px; height: 90px; }
            .zodiac-label { font-size: 0.75rem; }
            .start-btn { font-size: 1.1rem; }
            .start-btn-positioned { top: 90%; }
            #ui-container { bottom: calc(3% + var(--safe-bottom)); height: 8%; }
            #star-counter { font-size: 0.95rem; margin-bottom: 4px; }
            #explore-hint { font-size: 0.73rem; padding: 0 8px; }
            .message-box { width: 90%; padding: 26px 18px; font-size: 0.94rem; }

            #memory-1 { top: 11%; left: 9%; }
            #memory-2 { top: 76%; left: 20%; }
            #memory-3 { top: 34%; left: 91%; }
            #memory-4 { top: 78%; left: 87%; }
            #memory-5 { top: 44%; left: 6%; }
            #memory-6 { top: 9%; left: 79%; }
            #zodiac-1 { top: 22%; left: 78%; }
            #zodiac-2 { top: 72%; left: 14%; }
        }

        /* Large phones & small tablets (600px - 767px) */
        @media (min-width: 600px) and (max-width: 767px) {
            #dynamic-text { font-size: clamp(1.6rem, 8vw, 2.9rem); white-space: normal; }
            .memory-btn { width: 56px; height: 56px; }
            .title-wrapper { top: 30%; width: 90%; max-width: 90vw; }
            .zodiac-zone { width: 100px; height: 100px; }
            .zodiac-label { font-size: 0.78rem; }
            .start-btn { font-size: 1.2rem; }
            .start-btn-positioned { top: 89%; }
            #ui-container { bottom: calc(4% + var(--safe-bottom)); height: 8%; }
            #star-counter { font-size: 1.05rem; margin-bottom: 5px; }
            #explore-hint { font-size: 0.78rem; padding: 0 12px; }
            .message-box { width: 89%; padding: 28px 20px; max-height: 80vh; font-size: 0.95rem; }

            #memory-1 { top: 12%; left: 10%; }
            #memory-2 { top: 74%; left: 22%; }
            #memory-3 { top: 35%; left: 90%; }
            #memory-4 { top: 77%; left: 86%; }
            #memory-5 { top: 45%; left: 6%; }
            #memory-6 { top: 10%; left: 78%; }
            #zodiac-1 { top: 24%; left: 76%; }
            #zodiac-2 { top: 70%; left: 16%; }
        }

        /* Tablets (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            #dynamic-text { font-size: clamp(2rem, 7vw, 3.5rem); }
            .memory-btn { width: 65px; height: 65px; }
            .title-wrapper { top: 40%; width: 88%; }
            .zodiac-zone { width: 130px; height: 130px; }
            .start-btn { font-size: 1.5rem; }
            .start-btn-positioned { top: 65%; }
            #ui-container { bottom: calc(12% + var(--safe-bottom)); }
            #star-counter { font-size: 1.3rem; }
            #explore-hint { font-size: 0.9rem; padding: 0 18px; }
            .message-box { width: 85%; padding: 35px 25px; max-height: 80vh; }

            #memory-1 { top: 15%; left: 11%; }
            #memory-2 { top: 80%; left: 24%; }
            #memory-3 { top: 42%; left: 91%; }
            #memory-4 { top: 85%; left: 85%; }
            #memory-5 { top: 51%; left: 7%; }
            #memory-6 { top: 13%; left: 77%; }
            #zodiac-1 { top: 22%; left: 79%; }
            #zodiac-2 { top: 76%; left: 18%; }
        }

        /* Large tablets & small desktops (1025px - 1199px) */
        @media (min-width: 1025px) and (max-width: 1199px) {
            #dynamic-text { font-size: clamp(2.2rem, 6vw, 3.7rem); }
            .memory-btn { width: 68px; height: 68px; }
            .title-wrapper { top: 42%; }
            .zodiac-zone { width: 140px; height: 140px; }
            .start-btn { font-size: 1.6rem; }
            .start-btn-positioned { top: 63%; }
            #ui-container { bottom: calc(13% + var(--safe-bottom)); }
            #star-counter { font-size: 1.35rem; }
            #explore-hint { font-size: 0.92rem; }
            .message-box { width: 83%; padding: 38px 28px; }
        }

        /* Large desktops (1200px+) */
        @media (min-width: 1200px) {
            #dynamic-text { font-size: clamp(2.5rem, 5.5vw, 4rem); }
            .memory-btn { width: 70px; height: 70px; }
            .title-wrapper { top: 45%; }
            .zodiac-zone { width: 145px; height: 145px; }
            .start-btn { font-size: 1.7rem; }
            #star-counter { font-size: 1.4rem; }
            #explore-hint { font-size: 0.95rem; }
            .message-box { width: 80%; padding: 40px 30px; }
        }

        /* Landscape orientation tweaks */
        @media (max-height: 500px) and (orientation: landscape) {
            .title-wrapper { top: 35%; }
            .start-btn-positioned { top: 55%; }
            #ui-container { bottom: calc(4% + var(--safe-bottom)); }
            #dynamic-text { font-size: clamp(1rem, 4vw, 2rem); }
            .memory-btn { width: 48px; height: 48px; }
            .zodiac-zone { width: 95px; height: 95px; }
            .message-box { max-height: 85vh; padding: 25px 18px; }
        }

        /* iPad landscape support */
        @media (min-width: 1024px) and (max-height: 600px) and (orientation: landscape) {
            .title-wrapper { top: 38%; }
            #dynamic-text { font-size: clamp(1.8rem, 5vw, 3rem); }
            .start-btn-positioned { top: 58%; }
            #ui-container { bottom: calc(6% + var(--safe-bottom)); }
        }
    </style>
</head>
<body>

    <div class="bg-gradient"></div>
    <canvas id="warp-canvas"></canvas>
    <canvas id="universe-canvas"></canvas>

    <div id="progress-container"><div id="progress-bar"></div></div>

    <div class="title-wrapper">
        <h1 id="dynamic-text">My Universe</h1>
    </div>

    <button id="start-btn" class="start-btn start-btn-positioned" onclick="Actions.toggleExperience()" aria-label="play" title="play">â–¶</button>

    <div id="ui-container">
        <div id="star-counter">0 / 6 Whispers Found</div>
        <div id="explore-hint">The stars hold my secrets... find them.</div>
    </div>

    <button id="reveal-btn" style="display:none;"></button>
    <audio id="bg-music" crossorigin="anonymous" preload="auto" playsinline><source src="song.mp3" type="audio/mp3"></audio>

        <div class="memory-btn" id="memory-1" data-id="1"
         onmouseenter="Actions.hoverMemory(this, 'ðŸ’Œ', 'The Beginning', 'It all began when we started talking about your name, Babe. That simple conversation became the start of my everything.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸ’Œ', 'The Beginning', 'It all began when we started talking about your name, Babe. That simple conversation became the start of my everything.')">
         <div class="hint-dot"></div>
    </div>
        <div class="memory-btn" id="memory-2" data-id="2"
         onmouseenter="Actions.hoverMemory(this, 'ðŸŽï¸', 'Our Journey', 'This road is ours, Babe. I want to travel by your side through every turn, until the very end of my days.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸŽï¸', 'Our Journey', 'This road is ours, Babe. I want to travel by your side through every turn, until the very end of my days.')">
         <div class="hint-dot"></div>
    </div>
        <div class="memory-btn" id="memory-3" data-id="3"
         onmouseenter="Actions.hoverMemory(this, 'ðŸ’', 'My Proposal', 'In this vast universe, you are my only certainty, Babe. Will you hold my hand and walk this life with me forever?')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸ’', 'My Proposal', 'In this vast universe, you are my only certainty, Babe. Will you hold my hand and walk this life with me forever?')">
         <div class="hint-dot"></div>
    </div>
        <div class="memory-btn" id="memory-4" data-id="4"
         onmouseenter="Actions.hoverMemory(this, 'ðŸ’—', 'My Heart', 'My heart belongs to you completely. I will love you for all eternity. Happy Valentine\'s Day, Babe.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸ’—', 'My Heart', 'My heart belongs to you completely. I will love you for all eternity. Happy Valentine\'s Day, Babe.')">
         <div class="hint-dot"></div>
    </div>
        <div class="memory-btn" id="memory-5" data-id="5"
         onmouseenter="Actions.hoverMemory(this, 'ðŸŒ·', 'For You', 'Like tulips bloom in spring, you bring color to my world. My love for you grows brighter every day, Babe.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸŒ·', 'For You', 'Like tulips bloom in spring, you bring color to my world. My love for you grows brighter every day, Babe.')">
         <div class="hint-dot"></div>
    </div>
        <div class="memory-btn" id="memory-6" data-id="6"
         onmouseenter="Actions.hoverMemory(this, 'ðŸ«', 'Sweetness', 'I bought everything I thought you would love, Babe, hoping to see a smile as sweet as you are.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(this, 'ðŸ«', 'Sweetness', 'I bought everything I thought you would love, Babe, hoping to see a smile as sweet as you are.')">
         <div class="hint-dot"></div>
    </div>

        <div class="zodiac-zone" id="zodiac-1"
         onmouseenter="Actions.hoverMemory(null, 'â™ˆ', 'Your Aries', 'Born on April 7, 2000.<br>The soul that found its home in you.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(null, 'â™ˆ', 'Your Aries', 'Born on April 7, 2000.<br>The soul that found its home in you.')"><span class="zodiac-symbol">â™ˆ</span><span class="zodiac-label">Your Aries</span></div>
        <div class="zodiac-zone" id="zodiac-2"
         onmouseenter="Actions.hoverMemory(null, 'â™“', 'My Pisces', 'Born on March 1, 2006.<br>The dreamer who holds my heart.')"
         onmouseleave="Actions.hideMsg()"
         onclick="Actions.tapMemory(null, 'â™“', 'My Pisces', 'Born on March 1, 2006.<br>The dreamer who holds my heart.')"><span class="zodiac-symbol">â™“</span><span class="zodiac-label">My Pisces</span></div>

    <div class="message-box" id="msg-box">
        <div class="msg-header"><span class="msg-emoji" id="msg-emoji">âœ¨</span></div>
        <h2 class="msg-title" id="msg-title">Title</h2>
        <div class="msg-body" id="msg-body">Message text...</div>
    </div>

    <script>
        const CONFIG = {
            totalDuration: 171000,
            revealTime: 60000,
            totalStars: 6,
            colors: {
                neon: ['#ff00cc', '#3300cc', '#39ff14', '#00ffff'], 
                rose: 'rgba(255, 182, 193, 0.4)',
                gold: 'rgba(255, 215, 0, 0.5)',
                white: 'rgba(255, 255, 255, 0.8)'
            },
            phrases: [
                "My Universe",
                "Soe Wunna Htun âˆž Wutt Hmone Shwe Yi",
                "It's you, my love",
                "You are my little universe",
                "My heart beats only for you",
                "I love you in every universe",
                "I see my future with you",
                "Forever and Always",
                "Miles apart, but never at heart",
                "You are worth every mile between us",
                "Even after our fights, we always have each other",
                "Thanks for choosing me ðŸ’—",
                "Thanks for staying for me ðŸ’—",
                "Happy Valentine's, my love"
            ]
        };

        const State = {
            isPlaying: false,
            startTime: 0,
            // accumulated elapsed time when paused (ms)
            elapsedBeforePause: 0,
            // IDs for scheduled title cycling timers
            cycleTimer: null,
            fadeTimer: null,
            // scheduled lyrics to show at specific offsets (ms)
            scheduledLyrics: [],
            // active lyric timeouts
            lyricTimers: [],
                // scheduled lyric sequences
                scheduledSequences: [],
                // active sequence timers
                sequenceTimers: [],
                // flag when a lyric sequence is running
                inLyricSequence: false,
            foundStars: new Set(),
            isAllFound: false,
            activeMobileBtn: null,
            revealClicked: false,
            audioCtx: null,
            analyser: null,
            dataArray: null,
            pulseFactor: 1,
            _completeTimer: null
        };

        const DOM = {
            warpC: document.getElementById('warp-canvas'),
            univC: document.getElementById('universe-canvas'),
            warpCtx: document.getElementById('warp-canvas').getContext('2d'),
            univCtx: document.getElementById('universe-canvas').getContext('2d'),
            title: document.getElementById('dynamic-text'),
            audio: document.getElementById('bg-music'),
            hint: document.getElementById('explore-hint'),
            msgBox: document.getElementById('msg-box'),
            counter: document.getElementById('star-counter'),
            progress: document.getElementById('progress-bar'),
            emoji: document.getElementById('msg-emoji'),
            msgTitle: document.getElementById('msg-title'),
            msgBody: document.getElementById('msg-body')
        };

        let w, h;
        let warpStars = [], sparkles = [], shooters = [], neonShooters = [];
        let smallMeteors = [];
        let warpSpeed = 25, slowingDown = false;
        let phraseIndex = 0;

        class WarpStar {
            constructor() { this.reset(); }
            reset() { this.x = (Math.random()-0.5)*w; this.y = (Math.random()-0.5)*h; this.z = Math.random()*w; }
            update() { this.z -= warpSpeed; if(this.z < 1) this.z = w; }
            draw() {
                let sx = (this.x/this.z)*w + w/2, sy = (this.y/this.z)*h + h/2;
                DOM.warpCtx.fillStyle = "rgba(255,240,245,0.7)";
                let size = (1 - this.z/w) * (warpSpeed > 10 ? 2.5 : 1);
                DOM.warpCtx.beginPath(); DOM.warpCtx.arc(sx, sy, size, 0, Math.PI*2); DOM.warpCtx.fill();
            }
        }

        class Sparkle {
            constructor() { 
                this.x = Math.random()*w; this.y = Math.random()*h; 
                this.baseSize = Math.random()*1.5; 
                this.speed = 0.01 + Math.random()*0.02; 
            }
            draw() {
                let a = 0.1 + Math.abs(Math.sin(Date.now()*this.speed)*0.6);
                let size = this.baseSize * State.pulseFactor;
                DOM.univCtx.fillStyle = `rgba(255,245,250,${a})`;
                DOM.univCtx.beginPath(); DOM.univCtx.arc(this.x, this.y, size, 0, Math.PI*2); DOM.univCtx.fill();
            }
        }

        class NeonShooter {
            constructor() { 
                this.reset(); 
                this.color = CONFIG.colors.neon[Math.floor(Math.random() * CONFIG.colors.neon.length)];
            }
            reset() {
                this.x = Math.random() * w; 
                this.y = Math.random() * h * 0.6;
                this.len = Math.random() * 200 + 100; // Large tail
                this.speed = Math.random() * 20 + 15;  // Fast
                this.size = Math.random() * 3 + 3;     // Thick line
                this.dx = (Math.random() < 0.5 ? 1 : -1) * (Math.random() * 6 + 4);
                this.dy = Math.random() * 6 + 4;
                this.active = false;
                this.waitTime = Date.now() + Math.random() * 4000 + 1000;
                this.color = CONFIG.colors.neon[Math.floor(Math.random() * CONFIG.colors.neon.length)];
            }
            update() {
                if (!this.active) { if (Date.now() > this.waitTime) this.active = true; } 
                else {
                    this.x += this.dx; this.y += this.dy;
                    if (this.x < 0 || this.x > w || this.y > h) this.reset();
                }
            }
            draw() {
                if (!this.active) return;
                const ctx = DOM.univCtx;
                ctx.save();
                ctx.shadowBlur = 20; // Massive glow
                ctx.shadowColor = this.color;
                
                const grad = ctx.createLinearGradient(this.x, this.y, this.x - this.dx*3, this.y - this.dy*3);
                grad.addColorStop(0, '#ffffff');
                grad.addColorStop(0.3, this.color);
                grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.lineWidth = this.size; 
                ctx.strokeStyle = grad;
                ctx.beginPath(); 
                ctx.moveTo(this.x, this.y); 
                ctx.lineTo(this.x - this.dx*5, this.y - this.dy*5); 
                ctx.stroke();
                
                ctx.restore();
            }
        }

        class SmallMeteor {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * w;
                this.y = Math.random() * h * 0.4;
                this.len = Math.random() * 40 + 10;
                this.speed = Math.random() * 8 + 5;
                this.size = Math.random() * 1 + 0.5;
                this.dx = (Math.random() < 0.5 ? 1 : -1) * (Math.random() * 5 + 3);
                this.dy = Math.random() * 5 + 3;
                this.active = false;
                this.waitTime = Date.now() + Math.random() * 3000 + 1000;
            }
            update() {
                if (!this.active) { if (Date.now() > this.waitTime) this.active = true; }
                else {
                    this.x += this.dx; this.y += this.dy;
                    if (this.x < 0 || this.x > w || this.y > h) this.reset();
                }
            }
            draw() {
                if (!this.active) return;
                const grad = DOM.univCtx.createLinearGradient(this.x, this.y, this.x - this.dx*2, this.y - this.dy*2);
                grad.addColorStop(0, '#ffffff');
                grad.addColorStop(1, 'rgba(255, 215, 0, 0)');
                DOM.univCtx.lineWidth = this.size; DOM.univCtx.strokeStyle = grad;
                DOM.univCtx.beginPath(); DOM.univCtx.moveTo(this.x, this.y); DOM.univCtx.lineTo(this.x - this.dx*4, this.y - this.dy*4); DOM.univCtx.stroke();
            }
        }

        const Actions = {
            // Monotonic elapsed time in ms, prefers audio clock when playing
            getElapsedMs: () => {
                const audio = DOM.audio;
                if (State.isPlaying && audio && !isNaN(audio.currentTime) && audio.currentTime > 0) {
                    return audio.currentTime * 1000;
                }
                if (State.basePerfStart) {
                    return performance.now() - State.basePerfStart;
                }
                return State.elapsedBeforePause || 0;
            },

            setPlayButtonState: (playing) => {
                const btn = document.getElementById('start-btn');
                if (!btn) return;
                if (playing) {
                    btn.innerHTML = 'â¸';
                    btn.setAttribute('aria-label', 'pause');
                    btn.title = 'pause';
                } else {
                    btn.innerHTML = 'â–¶';
                    btn.setAttribute('aria-label', 'play');
                    btn.title = 'play';
                }
            },

            setTitleSmooth: (text, fadeMs = 220) => {
                if (!DOM.title) return;
                DOM.title.classList.add('text-fade-out');
                setTimeout(() => {
                    DOM.title.innerHTML = text;
                    Actions.fitTitle();
                    DOM.title.classList.remove('text-fade-out');
                }, fadeMs);
            },

            init: () => {
                Actions.resize();
                for(let i=0; i<250; i++) warpStars.push(new WarpStar());
                for(let i=0; i<500; i++) sparkles.push(new Sparkle());
                for(let i=0; i<3; i++) neonShooters.push(new NeonShooter());
                for(let i=0; i<5; i++) smallMeteors.push(new SmallMeteor());

                window.addEventListener('resize', Actions.resize, { passive: true });
                window.addEventListener('touchstart', (e) => {
                    if (State.activeMobileBtn && !e.target.closest('.memory-btn') && !e.target.closest('.message-box')) {
                        Actions.hideMsg(true);
                    }
                }, { passive: true });
                if (DOM.audio) DOM.audio.addEventListener('ended', Actions.handleAudioEnded);
                Actions.loop();
                setTimeout(() => slowingDown = true, 3800);
                // Schedule the requested lyric sequence (grouped) so original loop pauses while lyrics play
                Actions.scheduleLyricSequence([
                    { offsetMs: 73600, text: 'á€€á€±á€¬á€ºá€–á€®á€á€…á€ºá€á€½á€€á€ºá€›á€šá€º', durationMs: 2000 },
                    { offsetMs: 77000, text: 'á€€á€—á€»á€¬á€…á€¬á€¡á€¯á€•á€ºá€›á€šá€º', durationMs: 2400 },
                    { offsetMs: 78000, text: 'á€€á€­á€¯á€šá€ºá€œá€±á€™á€„á€ºá€¸á€”á€²á€·', durationMs: 3100 },
                    { offsetMs: 83500, text: 'á€¡á€á€°á€á€°á€›á€¾á€­á€™á€šá€º...', durationMs: 2800 }
                ]);
            },

            resize: () => {
                const viewport = window.visualViewport;
                w = Math.round(viewport ? viewport.width : window.innerWidth);
                h = Math.round(viewport ? viewport.height : window.innerHeight);
                const dpr = Math.max(window.devicePixelRatio || 1, 1);
                DOM.warpC.style.width = DOM.univC.style.width = w + 'px';
                DOM.warpC.style.height = DOM.univC.style.height = h + 'px';
                DOM.warpC.width = DOM.univC.width = Math.floor(w * dpr);
                DOM.warpC.height = DOM.univC.height = Math.floor(h * dpr);
                DOM.warpCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
                DOM.univCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
                Actions.fitTitle();
            },

            handleAudioEnded: () => {
                Actions.stopExperience({ resetElapsed: true });
                Actions.setPlayButtonState(false);
            },

            startExperience: () => {
                if (State.isPlaying) return;
                
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    State.audioCtx = new AudioContext();
                    State.analyser = State.audioCtx.createAnalyser();
                    State.analyser.fftSize = 64; 
                    const src = State.audioCtx.createMediaElementSource(DOM.audio);
                    src.connect(State.analyser);
                    State.analyser.connect(State.audioCtx.destination);
                    State.dataArray = new Uint8Array(State.analyser.frequencyBinCount);
                } catch(e) { console.log("Audio API fallback"); }

                DOM.audio.volume = 0.6;
                DOM.audio.play().catch(() => console.log("Visuals started without audio"));

                State.isPlaying = true;
                const resumed = State.elapsedBeforePause && State.elapsedBeforePause > 0;
                State.basePerfStart = performance.now() - (resumed ? State.elapsedBeforePause : 0);
                State.startTime = State.basePerfStart; // legacy support
                if (!resumed) State.elapsedBeforePause = 0;
                document.body.classList.add('active');
                warpSpeed = 0; 

                // Simple Fade & Loop Start
                Actions.cycleText();
                // (Re)schedule any queued lyrics for this run
                Actions._rescheduleLyrics();

            },

            cycleText: () => {
                if (!State.isPlaying) return;
                // clear any existing timers before scheduling
                if (State.cycleTimer) { clearTimeout(State.cycleTimer); State.cycleTimer = null; }
                if (State.fadeTimer) { clearTimeout(State.fadeTimer); State.fadeTimer = null; }
                State.cycleTimer = setTimeout(() => {
                    // abort if paused
                    if (!State.isPlaying) { State.cycleTimer = null; return; }
                    DOM.title.classList.add('text-fade-out');
                    State.fadeTimer = setTimeout(() => {
                        if (!State.isPlaying) { State.fadeTimer = null; return; }
                        phraseIndex = (phraseIndex + 1) % CONFIG.phrases.length;
                        DOM.title.innerHTML = CONFIG.phrases[phraseIndex];
                        DOM.title.classList.remove('text-fade-out');
                        Actions.fitTitle();
                        State.fadeTimer = null;
                        Actions.cycleText();
                    }, 1000);
                    State.cycleTimer = null;
                }, 4000);
            },

            fitTitle: () => {
                if (!DOM.title) return;
                // Reset to CSS default then shrink if needed
                DOM.title.style.fontSize = '';
                DOM.title.style.whiteSpace = 'nowrap';
                const containerWidth = Math.max(window.innerWidth * 0.9, 200);
                let computed = parseFloat(window.getComputedStyle(DOM.title).fontSize) || 32;
                const minSize = 14;
                let tries = 0;
                while (DOM.title.scrollWidth > containerWidth && computed > minSize && tries < 30) {
                    computed = Math.max(minSize, computed - 2);
                    DOM.title.style.fontSize = computed + 'px';
                    tries++;
                }
            },

            hoverMemory: (el, emoji, title, text) => {
                DOM.emoji.innerText = emoji;
                DOM.msgTitle.innerText = title;
                DOM.msgBody.innerHTML = text; // Fix for <br> tag using innerHTML
                DOM.msgBody.style.textAlign = 'center';
                DOM.msgBox.classList.add('visible');
                if(!State.isAllFound) DOM.hint.style.opacity = '0';
                
                if (el && el.dataset.id) {
                    const id = el.dataset.id;
                    if (!State.foundStars.has(id)) {
                        State.foundStars.add(id);
                        Actions.updateCounter();
                    }
                }
            },

            tapMemory: (el, emoji, title, text) => {
                if (State.activeMobileBtn === el) {
                    Actions.hideMsg(true);
                } else {
                    if (State.activeMobileBtn) State.activeMobileBtn.classList.remove('touch-active');
                    State.activeMobileBtn = el;
                    if(el) el.classList.add('touch-active');
                    Actions.hoverMemory(el, emoji, title, text);
                }
            },

            hideMsg: (force = false) => {
                if (State.activeMobileBtn && !force) return;
                DOM.msgBox.classList.remove('visible');
                if(!State.isAllFound && !State.revealClicked) DOM.hint.style.opacity = '1';
                if (force && State.activeMobileBtn) {
                    State.activeMobileBtn.classList.remove('touch-active');
                    State.activeMobileBtn = null;
                }
            },

            handleHintClick: () => {
                Actions.boostMemories();
                // Hide the hint message after clicking and mark as clicked
                State.revealClicked = true;
                DOM.hint.style.opacity = '0';
                DOM.hint.style.pointerEvents = 'none';
            },

            boostMemories: () => {
                // Don't highlight if all stars are already found
                if (State.isAllFound) return;
                
                // Make memory buttons more noticeable when user clicks the hint
                document.body.classList.add('highlight-mem');
                
                // Clear any existing highlight timeout
                if (State._highlightTimeout) {
                    clearTimeout(State._highlightTimeout);
                }
                
                // keep highlight until user interacts with a memory or after a timeout
                const clearAfter = 15000; // 15s
                const tid = setTimeout(() => { 
                    document.body.classList.remove('highlight-mem'); 
                }, clearAfter);
                // store so we could clear if needed
                State._highlightTimeout = tid;
            },

            updateCounter: () => {
                if (State.foundStars.size === CONFIG.totalStars) {
                    State.isAllFound = true;
                    DOM.counter.innerHTML = "âœ¨ You found all my hidden words. Well done, my love. âœ¨";
                    DOM.counter.classList.add('complete');
                    DOM.hint.style.display = 'default';
                    
                    // Reset reveal state: remove highlight and clear timeout
                    document.body.classList.remove('highlight-mem');
                    if (State._highlightTimeout) {
                        clearTimeout(State._highlightTimeout);
                        State._highlightTimeout = null;
                    }
                    
                    // Hide the reveal hint text
                    if (!DOM.hint.classList.contains('active-trigger')) {
                        DOM.hint.style.opacity = '0';
                        DOM.hint.style.pointerEvents = 'none';
                    }
                    
                    if (State._completeTimer) return;
                    State._completeTimer = setTimeout(() => {
                        DOM.counter.classList.remove('complete');
                        DOM.counter.classList.add('hidden');
                        State._completeTimer = null;
                    }, 9000);
                } else {
                    if (State._completeTimer) {
                        clearTimeout(State._completeTimer);
                        State._completeTimer = null;
                    }
                    DOM.counter.classList.remove('hidden');
                    DOM.counter.innerHTML = `${State.foundStars.size} / ${CONFIG.totalStars} Whispers Found`;
                    
                    // Restore hint visibility if not in active-trigger state and reveal not clicked
                    if (!DOM.hint.classList.contains('active-trigger') && !State.revealClicked) {
                        DOM.hint.style.opacity = '1';
                        DOM.hint.style.pointerEvents = 'auto';
                    }
                }
            },

            revealAll: () => {
                const storyHTML = `
                    <div style="font-size: 1.05rem; line-height: 1.9; padding: 0 5px;">
                        <div class="story-block"><span class="story-title">ðŸ’Œ The Beginning</span>It all began when we started talking about your name, Babe. <br>That simple conversation became the start of my everything.</div>
                        <div class="story-block"><span class="story-title">ðŸŽï¸ Our Journey</span>This road is ours, Babe. <br>I want to travel by your side through every turn,<br> until the very end of my days.</div>
                        <div class="story-block"><span class="story-title">ðŸ’ My Proposal</span>In this vast universe, you are my only certainty, Babe. <br>Will you hold my hand and walk this life with me forever?</div>
                        <div class="story-block"><span class="story-title">ðŸ’— My Heart</span>My heart belongs to you completely. I will love you for all eternity. <br>Happy Valentine's Day, Babe.</div>
                        <div class="story-block"><span class="story-title">ðŸŒ· For You</span>Like tulips bloom in spring, you bring color to my world. <br>My love for you grows brighter every day, Babe.</div>
                        <div class="story-block"><span class="story-title">ðŸ« Sweetness</span>I bought everything I thought you would love, Babe,<br>hoping to see a smile as sweet as you are.</div>
                        <div style="text-align:center; margin-top:30px;">
                            <button class="modal-close-btn" onclick="Actions.forceClose()">Close</button>
                        </div>
                    </div>`;
                
                DOM.emoji.innerText = "ðŸ’Œ";
                DOM.msgTitle.innerText = "Words I Want To Tell You";
                DOM.msgBody.innerHTML = storyHTML;
                DOM.msgBody.style.textAlign = 'left';
                DOM.msgBox.classList.add('visible');
            },

            // Schedule a temporary lyric to show at `offsetMs` milliseconds after experience start.
            // `durationMs` controls how long the lyric stays visible before reverting to the loop.
            // Example: Actions.scheduleLyric(30000, 'And I will always love you', 5000)
            scheduleLyric: (offsetMs, text, durationMs = 5000) => {
                const entry = { offsetMs, text, durationMs };
                State.scheduledLyrics.push(entry);
                // if experience is running, schedule immediately
                if (State.isPlaying) Actions._scheduleLyricEntry(entry);
            },

            // Schedule a sequence of lyrics that will run as a block. While a sequence
            // runs, the original loop is paused/stopped and will resume after the sequence.
            // entries: [{offsetMs, text, durationMs}, ...] - offsets are absolute (ms from start)
            scheduleLyricSequence: (entries) => {
                if (!entries || !entries.length) return;
                const seq = { entries: entries.slice() };
                State.scheduledSequences.push(seq);
                if (State.isPlaying) Actions._scheduleSequenceEntry(seq);
            },

            // Internal: schedule a single entry based on current startTime
            _scheduleLyricEntry: (entry) => {
                if (!entry) return;
                const elapsed = Actions.getElapsedMs();
                const timeUntil = entry.offsetMs - elapsed;
                // if the lyric time already passed but still within duration, show immediately for remaining time
                if (timeUntil <= 0 && timeUntil + entry.durationMs > 0) {
                    Actions._showTemporaryLyric(entry, entry.durationMs + timeUntil);
                    return;
                }
                if (timeUntil <= 0) return; // already past
                const id = setTimeout(() => { Actions._showTemporaryLyric(entry, entry.durationMs); }, timeUntil);
                State.lyricTimers.push(id);
            },

            _scheduleSequenceEntry: (seq) => {
                if (!seq || !seq.entries || !seq.entries.length) return;
                const startOffset = seq.entries[0].offsetMs;
                const elapsed = Actions.getElapsedMs();
                const timeUntil = startOffset - elapsed;
                const startDelay = 1000; // additional delay before sequence begins (ms)
                if (timeUntil <= 0) {
                    // schedule to start after short delay
                    const id0 = setTimeout(() => { Actions._startLyricSequence(seq); }, startDelay);
                    State.sequenceTimers.push(id0);
                    return;
                }
                const id = setTimeout(() => { Actions._startLyricSequence(seq); }, timeUntil + startDelay);
                State.sequenceTimers.push(id);
            },

            _startLyricSequence: (seq) => {
                if (!seq || !seq.entries || !seq.entries.length) return;
                // mark we're in a lyric sequence and stop normal cycling
                State.inLyricSequence = true;
                // clear pending cycle/fade timers
                if (State.cycleTimer) { clearTimeout(State.cycleTimer); State.cycleTimer = null; }
                if (State.fadeTimer) { clearTimeout(State.fadeTimer); State.fadeTimer = null; }
                // save phrase index so we can resume exactly where left off
                State._savedPhraseIndex = typeof phraseIndex === 'number' ? phraseIndex : 0;

                // transition/fade timing (ms)
                const fadeDur = 500;
                // gap between lines (ms) - extended by 500ms per request
                const interGap = 1000;
                // run entries sequentially starting at seq.entries[0].offsetMs
                const seqStart = seq.entries[0].offsetMs;
                const runBase = Actions.getElapsedMs();
                let cursor = 0; // relative time from sequence start
                seq.entries.forEach((entry, idx) => {
                    const showTime = cursor; // ms after seq start
                    const absFadeStart = Math.max(0, seqStart + showTime - fadeDur);

                    // schedule fade-out before showing the lyric
                    const fadeId = setTimeout(() => {
                        if (DOM.title) DOM.title.classList.add('text-fade-out');
                    }, Math.max(0, absFadeStart - runBase));
                    State.sequenceTimers.push(fadeId);

                    // schedule showing the lyric (fade-in after replacing text)
                    const showId = setTimeout(() => {
                        Actions.setTitleSmooth(entry.text, 180);
                    }, Math.max(0, seqStart + showTime - runBase));
                    State.sequenceTimers.push(showId);

                    // schedule fade-out at the end of this lyric display
                    const endFadeId = setTimeout(() => {
                        if (DOM.title) DOM.title.classList.add('text-fade-out');
                    }, Math.max(0, seqStart + showTime + entry.durationMs - runBase));
                    State.sequenceTimers.push(endFadeId);

                        // If last entry, restore saved phrase after fadeDur and resume loop (with extra pause)
                        if (idx === seq.entries.length - 1) {
                            const resumeDelay = 1000; // extra pause before resuming loop (ms)
                            const restoreId = setTimeout(() => {
                                const idxSaved = (typeof State._savedPhraseIndex === 'number') ? State._savedPhraseIndex : 0;
                                const nextText = CONFIG.phrases[idxSaved] || CONFIG.phrases[0];
                                Actions.setTitleSmooth(nextText, 200);
                                // small delay before restarting the cycle so it doesn't feel rushed
                                setTimeout(() => {
                                    State.inLyricSequence = false;
                                    if (State.isPlaying) Actions.cycleText();
                                }, resumeDelay);
                            }, Math.max(0, seqStart + showTime + entry.durationMs + fadeDur - runBase));
                            State.sequenceTimers.push(restoreId);
                        }

                    // advance cursor by entry duration + inter-gap
                    // add an extra 500ms gap after the first lyric as requested
                    if (idx === 0) cursor += entry.durationMs + interGap + 500;
                    else cursor += entry.durationMs + interGap;
                });
            },

            // Internal: show a lyric temporarily, suspend cycling while shown
            _showTemporaryLyric: (entry, duration) => {
                // Clear any scheduled cycle/fade so the loop won't change title mid-lyric
                if (State.cycleTimer) { clearTimeout(State.cycleTimer); State.cycleTimer = null; }
                if (State.fadeTimer) { clearTimeout(State.fadeTimer); State.fadeTimer = null; }

                // Save the current phrase index so we can restore the correct loop phrase
                State._savedPhraseIndex = typeof phraseIndex === 'number' ? phraseIndex : 0;

                Actions.setTitleSmooth(entry.text, 160);

                // schedule revert after duration
                const revertId = setTimeout(() => {
                    // restore loop phrase by index to avoid restoring previous temporary text
                    const idx = (typeof State._savedPhraseIndex === 'number') ? State._savedPhraseIndex : 0;
                    Actions.setTitleSmooth(CONFIG.phrases[idx] || CONFIG.phrases[0], 180);
                    // resume the normal cycle if still playing
                    if (State.isPlaying) Actions.cycleText();
                    // clear saved index once reverted
                    State._savedPhraseIndex = null;
                }, duration);
                State.lyricTimers.push(revertId);
            },

            // Reschedule all queued lyrics when experience starts or resumes
            _rescheduleLyrics: () => {
                // clear any existing lyric timers
                if (State.lyricTimers && State.lyricTimers.length) {
                    State.lyricTimers.forEach(id => clearTimeout(id));
                    State.lyricTimers = [];
                }
                // reschedule individual lyrics
                if (State.scheduledLyrics && State.scheduledLyrics.length) {
                    State.scheduledLyrics.forEach(entry => Actions._scheduleLyricEntry(entry));
                }
                // reschedule sequences
                if (State.scheduledSequences && State.scheduledSequences.length) {
                    // clear prior sequence timers
                    if (State.sequenceTimers && State.sequenceTimers.length) {
                        State.sequenceTimers.forEach(id => clearTimeout(id));
                        State.sequenceTimers = [];
                    }
                    State.scheduledSequences.forEach(seq => Actions._scheduleSequenceEntry(seq));
                }
            },

            forceClose: () => {
                DOM.msgBox.classList.remove('visible');
                if(!State.isAllFound) DOM.hint.style.opacity = '1';
                if (State.activeMobileBtn) {
                    State.activeMobileBtn.classList.remove('touch-active');
                    State.activeMobileBtn = null;
                }
            },

            stopExperience: (opts = {}) => {
                const { resetElapsed = false } = opts;
                if (!State.isPlaying && !resetElapsed) return;
                const elapsedToStore = resetElapsed ? 0 : Actions.getElapsedMs();
                State.elapsedBeforePause = elapsedToStore;
                State.isPlaying = false;
                if (State.cycleTimer) { clearTimeout(State.cycleTimer); State.cycleTimer = null; }
                if (State.fadeTimer) { clearTimeout(State.fadeTimer); State.fadeTimer = null; }
                if (DOM.title) {
                    DOM.title.classList.remove('text-fade-out');
                    if (resetElapsed) {
                        phraseIndex = 0;
                        State._savedPhraseIndex = null;
                        DOM.title.innerHTML = CONFIG.phrases[0];
                        Actions.fitTitle();
                    }
                }
                if (State.lyricTimers && State.lyricTimers.length) {
                    State.lyricTimers.forEach(id => clearTimeout(id));
                    State.lyricTimers = [];
                }
                if (State.sequenceTimers && State.sequenceTimers.length) {
                    State.sequenceTimers.forEach(id => clearTimeout(id));
                    State.sequenceTimers = [];
                }
                if (resetElapsed && DOM.progress) DOM.progress.style.width = '0%';
                try {
                    DOM.audio.pause();
                    if (resetElapsed) DOM.audio.currentTime = 0;
                } catch(e) {}
                document.body.classList.remove('active');
            },

            toggleExperience: () => {
                if (State.isPlaying) {
                    Actions.stopExperience();
                    Actions.setPlayButtonState(false);
                } else {
                    Actions.startExperience();
                    Actions.setPlayButtonState(true);
                }
            },

            loop: () => {
                DOM.warpCtx.clearRect(0,0,w,h); 
                DOM.univCtx.clearRect(0,0,w,h);

                if (State.analyser) {
                    State.analyser.getByteFrequencyData(State.dataArray);
                    let sum = 0;
                    for(let i=0; i<State.dataArray.length; i++) sum += State.dataArray[i];
                    let avg = sum / State.dataArray.length;
                    State.pulseFactor = 1 + Math.min((avg / 255), 0.4); 
                } else if (State.isPlaying) {
                    State.pulseFactor = 1 + Math.sin(Date.now() / 250) * 0.05; 
                }

                if(warpSpeed > 0.1) warpStars.forEach(s => { s.update(); s.draw(); });
                if(!State.isPlaying && slowingDown) warpSpeed *= 0.96;

                if(State.isPlaying) {
                    sparkles.forEach(s => s.draw());
                    smallMeteors.forEach(m => { m.update(); m.draw(); });
                    neonShooters.forEach(s => { s.update(); s.draw(); });
                    Actions.drawConstellations();

                    const elapsed = Actions.getElapsedMs();
                    const remaining = CONFIG.totalDuration - elapsed;
                    DOM.progress.style.width = Math.min((elapsed / CONFIG.totalDuration) * 100, 100) + "%";

                    if (remaining <= CONFIG.revealTime && !State.isAllFound) {
                        if (!DOM.hint.classList.contains('active-trigger')) {
                            DOM.hint.innerHTML = "Reveal the promises I have for you..<span class='click-span' onclick='Actions.handleHintClick()'>click here</span>";
                            DOM.hint.classList.add('active-trigger');
                        }
                    }
                    if (elapsed >= CONFIG.totalDuration) location.reload();
                }

                requestAnimationFrame(Actions.loop);
            },

            drawConstellations: () => {
                DOM.univCtx.strokeStyle = CONFIG.colors.gold;
                DOM.univCtx.lineWidth = 1.2 * State.pulseFactor;
                DOM.univCtx.shadowBlur = 8 * State.pulseFactor;
                DOM.univCtx.shadowColor = CONFIG.colors.rose;

                const draw = (pts, ox, oy) => {
                    DOM.univCtx.beginPath();
                    pts.forEach((p,i) => i===0 ? DOM.univCtx.moveTo(ox+p.x, oy+p.y) : DOM.univCtx.lineTo(ox+p.x, oy+p.y));
                    DOM.univCtx.stroke();
                    pts.forEach(p => { 
                        DOM.univCtx.fillStyle = "#fff"; 
                        DOM.univCtx.beginPath(); DOM.univCtx.arc(ox+p.x, oy+p.y, 2.5 * State.pulseFactor, 0, Math.PI*2); DOM.univCtx.fill(); 
                    });
                };
                
                draw([{x:0,y:20},{x:30,y:10},{x:60,y:15},{x:80,y:40}], w*0.78, h*0.2);
                draw([{x:0,y:0},{x:20,y:10},{x:40,y:30},{x:50,y:60},{x:60,y:90},{x:90,y:80},{x:110,y:70}], w*0.18, h*0.75);
            }
        };

        window.onload = Actions.init;
    </script>
</body>
</html>